<!DOCTYPE html>
<html>
<head>
	<title>Snake</title>
	<link rel="stylesheet" type="text/css" href="Snake.css">
</head>
<body>
	<div class="map">Coding by WangZhuo</div>
	<div style="text-align: center;margin:1rem;">
		<button id='testBtn'>ğŸ”restart</button>
	</div>
	<script type="text/javascript" src="Tool.js"></script>
	<script type="text/javascript">
		/**
		 *@author: wang zhuo
		 *@ä½œ   è€…: ç‹   å“
		 *@date: 2024/01/14
		 */

		//æ¸¸æˆå¯¹è±¡ç±»å‹
		class Scene{
			constructor(){
				this.map=document.querySelector('.map');
				this.width=this.map.clientWidth;
				this.height=this.map.clientHeight;
				this.blockWidth=30;
				this.score=0;
			}
			//è›‡èº«åŠ é•¿
			elongate() {
				var len = this.snake.length;
				var lastBody = this.snake[len-1];
				var lastBodyElm = lastBody.elm;
				var x,y;
				if(lastBody.direction === 'left' || lastBody.direction === 'right'){
					if(lastBody.direction === 'right'){
						x=lastBodyElm.offsetLeft-this.blockWidth;
					}else{
						x=lastBodyElm.offsetLeft+this.blockWidth;
					}
					y=lastBodyElm.offsetTop;
				}else{
					if(lastBody.direction === 'up'){
						y=lastBodyElm.offsetTop+this.blockWidth;
					}else{
						y=lastBodyElm.offsetTop-this.blockWidth;
					}
					x=lastBodyElm.offsetLeft;
				}
				var body = new Body({
					direction:lastBody.direction,
					x:x,
					y:y
				});
				this.snake.push(body);
				this.addToMap(body);
			}
			//å¾—åˆ†
			addScore(){
				this.score++;
				var food_x,food_y;

				food_x = random(0,this.width/this.blockWidth)*this.blockWidth;
				food_y = random(0,this.height/this.blockWidth)*this.blockWidth;
				console.log(this.width/this.blockWidth*(this.height/this.blockWidth))
				if(this.score<parseInt(this.width/this.blockWidth*(this.height/this.blockWidth))//åˆ¤æ–­è›‡æ˜¯å¦å æ®æ•´ä¸ªåœ°å›¾
				) {
					while(// ä¿è¯é£Ÿç‰©ç”Ÿæˆä½ç½®ä¸åœ¨è›‡èº«ä¸Š
						!this.snake.every(
							(body)=>{ return body.x!=food_x || body.y!=food_y; } 
						)
					){
						food_x = random(0,this.width/this.blockWidth)*this.blockWidth;
						food_y = random(0,this.height/this.blockWidth)*this.blockWidth;
					}
				}else{
					alert("æ­å–œä½ èµ¢å¾—äº†è¿™ä¸ªæ¸¸æˆï¼\nå¾—åˆ†ï¼š"+this.score)
					this.end();
				}

				this.food.x=food_x;
				this.food.y=food_y;
				this.elongate();
				this.refresh(this.food);

				//if(this.interval>100 && this.score %10 === 0){this.interval-=100;console.log("speed up~")}
			}
			//æ·»åŠ åˆ°DOM
			addToMap(obj){
				this.map.append(obj.elm);
			}
			//ä»DOMä¸­åˆ é™¤
			delFromMap(obj){
				// console.log(obj.elm)
				this.map.removeChild(obj.elm);
			}
			//æ›´æ–°DOM
			refresh(obj){
				obj.refresh();
			}
			//æ“ä½œå“åº”
			control(e){
				// console.log(this instanceof Scene)
				switch(e.keyCode){
					case 69://e
					case 38://â†‘
					if(this.head.direction!=='down') this.head.up();
					else console.log('ğŸš«ğŸ‘†')
					break;
					case 83://s
					case 37://â†
					if(this.head.direction!=='right') this.head.left();
					else console.log('ğŸš«ğŸ‘ˆ')
					break;
					case 68://d
					case 40://â†“
					if(this.head.direction!=='up') this.head.down();
					else console.log('ğŸš«ğŸ‘‡')
					break;
					case 70://f
					case 39://â†’
					if(this.head.direction!=='left') this.head.right();
					else console.log('ğŸš«ğŸ‘‰')
					break;
					default:
					alert("â¸æ¸¸æˆæš‚åœ\næ“ä½œæ–¹å¼ï¼š\nEæˆ–â†‘é”®ï¼šå‘ä¸ŠğŸ‘†\nDæˆ–â†“é”®ï¼šå‘ä¸‹ğŸ‘‡\nSæˆ–â†é”®ï¼šå‘å·¦ğŸ‘ˆ\nFæˆ–â†’é”®ï¼šå‘å³ğŸ‘‰\n");
					break;
				}
				this.refresh(this.head);
			}
			//ç¢°æ’æ£€æŸ¥
			regionCheck(obj){
				// let scene = this;
				// console.log(this instanceof Scene);//false
				var head = scene.snake[0];
				if(obj instanceof Body){
					if(obj.x <= head.x+scene.blockWidth/2 && head.x+scene.blockWidth/2 <= obj.x + scene.blockWidth && obj.y <= head.y+scene.blockWidth/2 && head.y+scene.blockWidth/2 <= obj.y + scene.blockWidth){
						return false;// è›‡å¤´ç¢°åˆ°è›‡èº«ï¼Œæ¸¸æˆç»“æŸ
					}
				}
				if(head.x<0||head.y<0||head.x>scene.width-scene.blockWidth||head.y>scene.height-scene.blockWidth){
					return false; //ç¢°åˆ°åœ°å›¾ç¼–è¯‘ï¼Œæ¸¸æˆç»“æŸ
				}
				if(obj instanceof Food){
					if(obj.x <= head.x + scene.blockWidth/2 && head.x + scene.blockWidth <= obj.x + scene.blockWidth && obj.y <= head.y + scene.blockWidth/2 && head.y + scene.blockWidth/2 <= obj.y + scene.blockWidth){

						scene.addScore();//åƒåˆ°é£Ÿç‰©ï¼ŒåŠ åˆ†
					}
				}
				return true;
			}
			//è›‡ç§»åŠ¨
			moveSnake(){
				// console.log(this instanceof Scene)//true

				var head = this.snake[0];
				var len = this.snake.length;

				var body;
				if(len>1){
					var tail = this.snake[len-1];
					this.delFromMap(tail);
					this.snake.splice(len-1,1);
					body = new Body({x:head.x,y:head.y,direction:head.direction});
					this.snake.splice(1,0,body);
					
				}
				switch(head.direction){
					case 'up':
					head.y -= this.blockWidth;
					break;
					case 'down':
					head.y += this.blockWidth;
					break;
					case 'left':
					head.x -= this.blockWidth;
					break;
					case 'right':
					head.x += this.blockWidth;
					break;
				}
				this.refresh(head);
				if(len>1){this.addToMap(body);}
				if(len>2)if(this.snake.slice(2).every(this.regionCheck)); else return false;
				if(this.regionCheck(this.food)); else return false;
				
				return true;
			}
			//åˆå§‹åŒ–
			init(){
				this.snake=[];
				this.head=new Head();
				this.food=new Food();
				this.snake.push(this.head);
				this.addToMap(this.head);
				this.addToMap(this.food);
				//document.addEventListener('keydown',(e)=>{this.control(e);},this);
				document.onkeydown=(e)=>{this.control(e);}
				this.score=0;
				this.interval=200;
			}
			//é‡ç½®ç¯å¢ƒ
			reset(){

				this.delFromMap(this.food)
				for(let i in this.snake){
					this.delFromMap(this.snake[i]);
				}
				this.init();
			}
			//è¿è¡Œæ¸¸æˆ
			run(){
				if(confirm("ç‚¹å‡»ç¡®è®¤å¼€å§‹æ¸¸æˆ")){
					let that=this;
					this.mainTimer = setInterval(function(){
						// console.log(this instanceof Scene)//false
						if(that.moveSnake()){ }
						else{
							if(confirm(`æ‚¨çš„å¾—åˆ†ï¼š${that.score}`)){
								that.reset();
							}else{
								that.end();
							}
						};
					},this.interval);
				}				
			}

			//ç»“æŸæ¸¸æˆ
			end(){
				clearInterval(this.mainTimer);
				document.onkeydown=null;
				this.delFromMap(this.food)
				for(let i in this.snake){
					this.delFromMap(this.snake[i]);
				}
			}
		}
		//æ¸¸æˆå¯¹è±¡ç±»å‹
		class GameObj{
			constructor(name,x,y){
				this.name=name;
				this.x=x;
				this.y=y;
				this.elm=gameObjFactory(name,x,y);
			}
			refresh(){
				this.elm.style.left=this.x+'px';
				this.elm.style.top=this.y+'px';
			}
		}
		//é£Ÿç‰©ç±»å‹
		class Food extends GameObj{
			constructor(){
				var x=random(0,scene.width/scene.blockWidth)*scene.blockWidth;
				var y=random(0,scene.height/scene.blockWidth)*scene.blockWidth;
				super('food',x,y);
			}
		}
		//è›‡å¤´ç±»å‹
		class Head extends GameObj{
			constructor(){
				var x=Math.floor(0.25*scene.width/scene.blockWidth)*scene.blockWidth;
				var y=Math.floor(0.5*scene.height/scene.blockWidth)*scene.blockWidth;
				super('head',x,y);
				this.direction='right';
			}
			up(){this.direction='up';}
			down(){this.direction='down';}
			left(){this.direction='left';}
			right(){this.direction='right';}
			refresh(){
				this.elm.style.left=this.x+'px';
				this.elm.style.top=this.y+'px';
				var degree = 0;
				switch(this.direction){
					case 'right':
					degree=0;
					break;
					case 'down':
					degree=90;
					break;
					case 'left':
					degree=180;
					break;
					case 'up':
					degree=270;
					break;
				}
				this.elm.style.transform=`rotate(${degree}deg)`;
				// console.log('head rendered')
			}
		}
		//è›‡èº«ç±»å‹
		class Body extends GameObj{
			constructor(arg){
				super('body',arg.x,arg.y);
				this.direction=arg.direction;
			}
		}

		var scene=new Scene();
		scene.init();
		scene.run();

		//å°†testBtnå…ƒç´ .style.visibilityè®¾ä¸ºå¯è§æ—¶ï¼Œè¦æµ‹è¯•å“ªä¸ªæ–¹æ³•å°±åœ¨onclickä¸­è°ƒç”¨å“ªä¸ªæ–¹æ³•
		var testBtn = document.querySelector("#testBtn");
		testBtn.innerText="ğŸ”é‡æ–°å¼€å§‹";
		testBtn.style.visibility="visible";
		// createBodyBtn.style.visibility='visible';
		testBtn.onclick = function (argument) {
			// scene.end()
			location.reload(false);
		}
	</script>
</body>
</html>